<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Watch Scanner</title>
    <style>
        /* Basic Reset and Body Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden; /* Prevents scrollbars */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Main container for the entire app */
        .scanner-app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Container for the video feed and overlays */
        #camera-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            height: auto;
            display: none; /* Hidden until camera is active */
            flex-direction: column;
            align-items: center;
            border: 4px solid hotpink; /* Outer neon pink outline */
            box-shadow: 0 0 15px hotpink;
            border-radius: 10px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* This is the overlay that holds the scanner box and line */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The inner pink targeting box */
        .scanner-box {
            width: 80%;
            height: 70%;
            border: 3px solid hotpink;
            position: relative;
            overflow: hidden; /* Keep the scanner line inside this box */
        }

        /* The animated blue scanner line */
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: cyan;
            box-shadow: 0 0 10px cyan, 0 0 20px cyan;
            animation: scan-animation 3s infinite linear;
        }

        /* CSS animation for the scanner line */
        @keyframes scan-animation {
            0% { top: 0; }
            50% { top: calc(100% - 4px); }
            100% { top: 0; }
        }

        /* Button to snap the picture */
        #snap-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid #444;
            cursor: pointer;
            margin-top: 20px;
        }

        /* UI for displaying results or messages */
        #results-ui {
            display: none; /* Hidden by default */
            width: 90%;
            max-width: 600px;
            padding: 20px;
            text-align: center;
        }

        #results-ui h3 {
            color: hotpink;
        }

        #results-content {
            margin-top: 20px;
            padding: 15px;
            background-color: #1a1a1a;
            border-radius: 5px;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #scan-again-btn {
            padding: 12px 20px;
            font-size: 16px;
            background-color: hotpink;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* Hidden canvas for processing the image */
        #canvas {
            display: none;
        }
    </style>
</head>
<body>

    <div class="scanner-app">
        <!-- The Camera View -->
        <div id="camera-container">
            <video id="video" playsinline autoplay muted></video>
            <div class="scanner-overlay">
                <div class="scanner-box">
                    <div class="scanner-line"></div>
                </div>
            </div>
        </div>
        <button id="snap-btn" onclick="snapPicture()" style="display: none;">_</button>

        <!-- The Results View -->
        <div id="results-ui">
            <h3 id="results-title">Scan Results</h3>
            <div id="results-content"></div>
            <button id="scan-again-btn" onclick="initializeApp()">Scan Another Watch</button>
        </div>
    </div>

    <!-- Hidden canvas element -->
    <canvas id="canvas"></canvas>

    <script>
        // Get all necessary DOM elements
        const cameraContainer = document.getElementById('camera-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snap-btn');
        const resultsUI = document.getElementById('results-ui');
        const resultsTitle = document.getElementById('results-title');
        const resultsContent = document.getElementById('results-content');

        // This function starts the whole process
        async function initializeApp() {
            // Reset UI state
            resultsUI.style.display = 'none';
            cameraContainer.style.display = 'flex';
            snapBtn.style.display = 'block';
            resultsContent.innerHTML = 'Initializing Camera...';

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    // Request access to the user's camera, preferring the back camera
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    video.srcObject = stream;
                    // The 'autoplay' attribute on the video tag will handle playing

                } catch (error) {
                    console.error("Error accessing camera: ", error);
                    showError("Camera access denied. Please allow camera access in your browser settings and refresh the page.");
                }
            } else {
                showError("Sorry, your browser does not support camera access.");
            }
        }

        // Function to capture the picture
        function snapPicture() {
            // Show scanning state
            showResultsView("Scanning...", "Please wait while we analyze the image.");

            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Stop the camera stream to save battery
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            // Convert the canvas image to a Blob (a file-like object)
            canvas.toBlob(blob => {
                scanWatch(blob);
            }, 'image/jpeg');
        }

        // Main function to send the image to the server
        async function scanWatch(imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile, 'watch-capture.jpg');

            try {
                const response = await fetch('https://watch-scanner.onrender.com/scan', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json();
                showResultsView("Scan Complete", JSON.stringify(data, null, 2));

            } catch (error) {
                console.error('Error:', error);
                showError(`Scan Failed: ${error.message}. Please try again.`);
            }
        }

        // Helper function to switch to the results view
        function showResultsView(title, content) {
            cameraContainer.style.display = 'none';
            snapBtn.style.display = 'none';
            resultsUI.style.display = 'block';
            resultsTitle.textContent = title;
            resultsContent.textContent = content;
        }

        // Helper function to show a critical error
        function showError(message) {
            cameraContainer.style.display = 'none';
            snapBtn.style.display = 'none';
            resultsUI.style.display = 'block';
            resultsTitle.textContent = 'Error';
            resultsContent.textContent = message;
        }

        // Start the application as soon as the page is loaded
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
